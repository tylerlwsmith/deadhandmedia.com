{{ define "main" }}
  {{- $perPage := or (os.Getenv "HUGO_POSTS_PER_PAGE") 1000 -}}
  {{- .Scratch.Set "posts" ( getJSON "https://dev.to/api/articles?username=tylerlwsmith&per_page=" $perPage) -}}

  {{/*  Must use newScratch instead of .Scratch: .Scratch doesn't work in range in Hugo 0.93.  */}}
  {{- $scratch := newScratch -}}  
  {{- $scratch.Set "allYears" (slice) -}} 
  {{- range (.Scratch.Get "posts") -}}
    {{- $year := time.Format "2006" .published_at -}}
    {{/* Can't use isSet: checks to see if a key's value is null, not if a key exists. */}}
    {{- if in ($scratch.Get "allYears") $year -}}
      {{- $scratch.SetInMap "yearCounts" $year (dict "year" $year "count" (add (index ($scratch.Get "yearCounts") $year).count 1)) -}}
    {{- else -}}
      {{- $scratch.SetInMap "yearCounts" $year (dict "year" $year "count" 1) -}}
    {{- end -}}
    {{- $scratch.Add "allYears" $year -}}
  {{- end -}}

  <div 
    class="page-blog-list container"
    x-data="{
      activeFilters: $persist([]).as('active-blog-filters'),
      resetFilters() {
        this.activeFilters = [];
      },
      classBinder() {
        return this.activeFilters.length > 0 && this.tagList.filter(tag => this.activeFilters.includes(tag)).length === 0 ? 'hidden' : ''
      }
    }"
    x-init="
      setTimeout(() => {
        activeFilters = [...document.querySelectorAll(`input[type='checkbox'][x-model='activeFilters']`)]
        .filter(el => el.checked)
        .map(el => el.value);
      }, 0);
    ">
    {{- partial "blog-filter-sidebar.html" . -}}

    <main id="main" class="content-column">
      <article class="content-area">
        <h1 
          class="page__title" 
          data-total-posts="{{ len (.Scratch.Get "posts") }}"
        >
          {{ .Title }}
        </h1>
        {{ .Content }}
      </article>

      <div class="active-filter__container">
        <template x-if="activeFilters.length > 0">
          <div class="active-filter__list">
            <span class="active-filter__label">Active Filters:</span> 
            <template x-for="activeFilter in activeFilters">
              <button 
                class="active-filter"
                data="{activeFilter: activeFilter}"
                x-text="`&times; ${activeFilter}`"
                x-on:click="activeFilters = activeFilters.filter(filter => filter !== activeFilter)"
              ></button>`
            </template>
          </div>
        </template>
      </div>

      {{- $yearIndex := "" -}}
      {{- range .Scratch.Get "posts" -}}
        {{- $postYear :=  time.Format "2006" .published_at -}}
        {{- if ne $yearIndex $postYear -}}
          {{- $yearIndex = $postYear -}}
          <h2
            class="page-blog-list__year-heading"
            x-bind:class="activeFilters.length > 0 ? 'hidden' : ''"
          >
            <span class="page-blog-list__year-heading-inner">
              <span class="page-blog-list__year">{{ $yearIndex }}</span>
              <span class="page-blog-list__year-count">
                {{- $count := (index ($scratch.Get "yearCounts") $yearIndex).count -}}
                {{- $count }} {{cond (eq $count 1) "post" "posts" -}}
              </span>
            </span>
          </h2>
        {{- end -}}
        <article 
          x-data="{tagList: {{ jsonify .tag_list }}}"
          class="blog-preview"
          x-bind:class="classBinder()"
        >
          <h3 class="blog-preview__title">
            <a href="{{ .url }}" class="blog-preview__link">{{ .title }}</a>
          </h3>

          <ul 
            class="blog-preview__tag-list"
            x-cloak
            x-bind:class="activeFilters.length === 0 ? 'hidden' : ''"
          >
            {{- range .tag_list -}}
              <li class="blog-preview__tag">#{{ . }}</li>
            {{- end -}}
          </ul>
          
          <div class="blog-preview__meta-wrapper">
            <time 
              class="blog-preview__published_date"
              datetime="{{ time.Format "2006-01-02" .published_at }}"
            >
              {{ time.Format "Jan 2, 2006" .published_at }}
            </time>
            <dl 
              class="blog-preview__meta-list"
              x-cloak
              x-bind:class="activeFilters.length === 0 ? 'hidden' : ''"
            >
              {{- if .public_reactions_count -}}
                <div class="blog-preview__meta-list-item">
                  <dt class="blog-preview__meta-term">reactions</dt>
                  <dd class="blog-preview__meta-detail">
                    {{ .public_reactions_count }}
                  </dd>
                </div>
              {{- end -}}
  
              {{- if .comments_count -}}
                <div class="blog-preview__meta-list-item">
                  <dt class="blog-preview__meta-term">comments</dt>
                  <dd class="blog-preview__meta-detail">
                    {{ .comments_count }}
                  </dd>
                </div>
              {{- end -}}
            </dl>
          </div>
        </article>
      {{- end -}}
    </main>
  </div>

{{- end -}}

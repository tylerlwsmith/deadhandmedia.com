{{ define "main" }}
	{{ $posts := getJSON "https://dev.to/api/articles?username=tylerlwsmith&per_page=1000" }}

	<div class="container">
		<main class="content-wrapper">
			<article>
				<h1 class="page__title">{{ .Title }}</h1>
				{{ .Content }}
			</article>

			<div style="display: flex;">
				<div>
					{{ $yearIndex := "" }}
					{{ range $posts }}
						{{ $postYear :=  time.Format "2006" .published_at }}
						{{ if ne $yearIndex $postYear }}
							{{ $yearIndex = $postYear }}
							<h2 data-year-heading>{{ $yearIndex }}</h2>
						{{ end }}
						<article data-tags="{{ jsonify .tag_list }}">
							<h3><a href="{{ .url }}">{{ .title }}</a></h3>
						</article>
					{{ end }}
				</div>

				{{ if eq hugo.Environment "development" }}
					{{ $tags := newScratch }}	
					{{ $tags.Set "allTags" (slice)}} 
					{{ range $posts }}
						{{ range .tag_list }}
							{{/* Can't use isSet: checks to see if a key's value is null, not if a key exists. */}}
							{{ if in ($tags.Get "allTags") . }}
								{{ $tags.SetInMap "withCount" . (dict "tag" . "count" (add (index ($tags.Get "withCount") .).count 1))  }}
							{{ else }}
								{{ $tags.SetInMap "withCount" . (dict "tag" . "count" 1)  }}
							{{ end }}
							{{ $tags.Add "allTags" . }}
						{{ end }}
					{{ end }}
					<aside style="order: -1; padding: 0 20px 0 0; min-width: 200px;">
						<button id="clear-filters">Clear Filters</button>
						<ul style="margin: 0; list-style: none; padding: 0; font-size: 14px;">
							{{ range sort ($tags.Get "withCount") "tag" "asc" }}
								<li>
									<input 
										type="checkbox"
										name="{{ .tag }}"
										id="tag:{{ .tag }}"
										class="blog-tag"
									>
									<label for="tag:{{ .tag }}">{{ .tag }}: {{ .count }}</label>
								</li>
							{{ end }}
						</ul>
					</aside>

					<script>
						(function() {
							const checkboxSelector = ".blog-tag";

							[...getCheckboxes()].forEach(tag => {
								tag.addEventListener('click', filterPosts);
							});

							document.getElementById("clear-filters").addEventListener("click", function() {
								[...getCheckboxes()].forEach(checkBox => checkBox.checked = false);
								filterPosts();
							});

							// Refires filters when navigating back from dev.to
							window.addEventListener('pageshow', function() {
								filterPosts();
							})
							function getCheckboxes () {
								return document.querySelectorAll(checkboxSelector);
							}
							function getActiveTags () {
								return [...document.querySelectorAll(checkboxSelector + ":checked")]
									.map(checkbox => checkbox.name);
							}
							function getPosts () {
								return document.querySelectorAll('[data-tags]');
							}
							function getYearHeadings() {
								return document.querySelectorAll(['[data-year-heading]'])
							}
							function hideYearHeadings() {
								return [...getYearHeadings()].forEach(heading => heading.style.display = "none")
							}
							function showYearHeadings() {
								return [...getYearHeadings()].forEach(heading => heading.style.display = "block")
							}
							function filterPosts() {
								const activeTags = getActiveTags();
								[...getPosts()].forEach(post => {
									if (activeTags.length === 0) {
										post.style.display = "block"; 
										showYearHeadings();
										return;
									}

									const postTags = JSON.parse(post.dataset.tags);
									const matchingTags = activeTags.filter(activeTag => postTags.indexOf(activeTag) > -1);

									hideYearHeadings();
									post.style.display = matchingTags.length 
										? "block"
										: "none";
								});
							}
						})();
					</script>
				{{ end }}
			</div>
		</main>
	</div>
{{ end }}

{{ define "main" }}
	{{ $posts := getJSON "https://dev.to/api/articles?username=tylerlwsmith&per_page=1000" }}

	<div class="container">
		<main class="content-wrapper">
			<article>
				<h1 class="page__title">{{ .Title }}</h1>
				{{ .Content }}
			</article>

			<div style="display: flex;">
				<div>
					{{ $yearIndex := "" }}
					{{ range $posts }}
						{{ $postYear :=  time.Format "2006" .published_at }}
						{{ if ne $yearIndex $postYear }}
							{{ $yearIndex = $postYear }}
							<h2 data-year-heading>{{ $yearIndex }}</h2>
						{{ end }}
						<article data-tags="{{ jsonify .tag_list }}">
							<h3>
								<a href="{{ .url }}">{{ .title }}</a>
							</h3>
							{{ if eq hugo.Environment "development" }}
								<time datetime="{{ time.Format "2006-01-02" .published_at }}">
									{{ time.Format "Jan 2, 2006" .published_at }}
								</time>
								<ul>
									{{ range .tag_list }}
										<li>#{{ . }}</li>
									{{ end }}
								</ul>
								<dl>
									<dt>comments</dt>
									<dd>{{ .comments_count }}</dd>
									<dt>reacts</dt>
									<dd>{{ .public_reactions_count }}</dd>
								</dl>
							{{ end }}
						</article>
					{{ end }}
				</div>

				{{ if eq hugo.Environment "development" }}
					{{ $tags := newScratch }}	
					{{ $tags.Set "allTags" (slice)}} 
					{{ range $posts }}
						{{ range .tag_list }}
							{{/* Can't use isSet: checks to see if a key's value is null, not if a key exists. */}}
							{{ if in ($tags.Get "allTags") . }}
								{{ $tags.SetInMap "withCount" . (dict "tag" . "count" (add (index ($tags.Get "withCount") .).count 1))  }}
							{{ else }}
								{{ $tags.SetInMap "withCount" . (dict "tag" . "count" 1)  }}
							{{ end }}
							{{ $tags.Add "allTags" . }}
						{{ end }}
					{{ end }}
					<aside style="order: -1; padding: 0 20px 0 0; min-width: 200px;">
						<button id="reset-filters" class="blog-filter__reset-button">
							Reset Filters
						</button>

						<h3>Tags</h3>
						<ul class="blog-filter__list">
							{{ range sort ($tags.Get "withCount") "tag" "asc" }}
								<li class="blog-filter__wrapper">
									<input 
										type="checkbox"
										name="{{ .tag }}"
										id="tag:{{ .tag }}"
										class="blog-filter"
										data-blog-tag
									>
									<label for="tag:{{ .tag }}" class="blog-filter__label">{{ .tag }}: {{ .count }}</label>
								</li>
							{{ end }}
						</ul>
					</aside>
					<script src="{{- (resources.Get "js/blog.js").RelPermalink -}}"></script>
				{{ end }}
			</div>
		</main>
	</div>
{{ end }}
